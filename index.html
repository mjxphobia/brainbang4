<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ZOMBIE CITY4</title>

<style>
body{
  margin:0;
  background:#ffffff;
  font-family: Arial, Helvetica, sans-serif;
  color:#111;
}

.wrap{
  width:100%;
  text-align:center;
}

.title{
  font-size:22px;
  font-weight:700;
  margin:20px 0 12px;
}

.card{
  width:1024px;
  height:768px;
  max-width:92vw;
  margin:0 auto;
  border:2px solid #111;
  position:relative;
  overflow:hidden;
  background:#fff;
}

.layer{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
}

#cityImg{
  height:100%;
  width:auto;
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  user-select:none;
  pointer-events:none;
}

#zombieImg,#puzzleImg{
  width:100%;
  height:100%;
  object-fit:contain;
  display:none;
  user-select:none;
  pointer-events:none;
}

.ui{
  width:1024px;
  max-width:92vw;
  margin:12px auto 0;
}

.timer{
  font-family: ui-monospace, monospace;
  font-size:48px;
  display:none;
}

.answerRow{
  display:none;
  margin-top:8px;
}

input{
  border:2px solid #111;
  padding:12px;
  font-size:18px;
  width:260px;
  text-align:center;
}

.controls{
  width:1024px;
  max-width:92vw;
  margin:16px auto;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

button{
  border:2px solid #111;
  background:#fff;
  padding:12px;
  font-size:16px;
  cursor:pointer;
}
button:active{ transform: translateY(1px); }
</style>
</head>

<body>
<div class="wrap">

  <div class="title">ZOMBIE CITY4</div>

  <div class="card">
    <div class="layer"><img id="cityImg"></div>
    <div class="layer"><img id="zombieImg"></div>
    <div class="layer"><img id="puzzleImg"></div>
  </div>

  <div class="ui">
    <div id="timer" class="timer">15</div>
    <div id="answerRow" class="answerRow">
      <input id="answerInput" placeholder="ANSWER">
      <div>ENTER 누르기</div>
    </div>
  </div>

  <div class="controls">
    <button onclick="location.reload()">다시 시작</button>
    <button onclick="location.href='index.html'">메뉴</button>
  </div>

  <!-- ✅ 랜덤 좀비 그로울 사운드 -->
  <audio id="groan"></audio>
  <!-- ✅ 실패 사운드 -->
  <audio id="scratch" src="static/scratch.mp3" preload="auto"></audio>
  <audio id="gunshot" src="static/gunshot.mp3" preload="auto"></audio>

</div>

<script>
/* ---------- 이미지 ---------- */
const cityImages   = Array.from({length:5},(_,i)=>`static/city${i+1}.png`);
const zombieImages = Array.from({length:5},(_,i)=>`static/zombie${i+1}.png`);

/* ---------- 사운드 ---------- */
const groanSounds = Array.from({length:9},(_,i)=>`static/groan${i+1}.mp3`);

/* ---------- 퍼즐 ---------- */
const puzzles = [
  { img:"static/puzzle4-1.png", answer:"4" },
  { img:"static/puzzle4-2.png", answer:"SAFE" },
  { img:"static/puzzle4-3.png", answer:"픂푶" }
];

/* ---------- 요소 ---------- */
const cityImg = document.getElementById("cityImg");
const zombieImg = document.getElementById("zombieImg");
const puzzleImg = document.getElementById("puzzleImg");
const timerEl = document.getElementById("timer");
const answerRow = document.getElementById("answerRow");
const answerInput = document.getElementById("answerInput");

const groanEl = document.getElementById("groan");
const scratchEl = document.getElementById("scratch");
const gunshot = document.getElementById("gunshot");


/* ---------- 유틸 ---------- */
const rand = arr => arr[Math.floor(Math.random()*arr.length)];

function playSound(el, src){
  try{
    if(src) el.src = src;
    el.pause();
    el.currentTime = 0;
    el.play();
  }catch(e){}
}

function warmUp(el, src){
  try{
    el.src = src;
    el.muted = true;
    el.play();
    el.pause();
    el.currentTime = 0;
    el.muted = false;
  }catch(e){}
}

/* ---------- 상태 ---------- */
let puzzleIndex = 0;
let phase = "CITY";
let rafId = null;
let countdownId = null;
let audioReady = false;

/* ---------- 타이밍 (랜덤 겹침 방지 구조 유지) ---------- */
const CYCLE_MS = 80000;
const SLOT_MS  = 15000;
const GUARD_MS = 5000;
const PAGE_ID = 4;
const SLOT_START_MS = (PAGE_ID - 1) * (SLOT_MS + GUARD_MS);

function seededRandom01(cycleIndex){
  let x = (cycleIndex + 1) * 1103515245 + PAGE_ID * 12345;
  x ^= x >>> 16;
  return (x >>> 0) / 4294967295;
}

function scheduleZombie(){
  if(phase !== "CITY") return;
  const now = Date.now();
  const cycle = Math.floor(now / CYCLE_MS);
  const inCycle = now % CYCLE_MS;

  const r = seededRandom01(cycle);
  const target = SLOT_START_MS + GUARD_MS + r * (SLOT_MS - GUARD_MS*2);
  let wait = target - inCycle;
  if(wait < 0) wait += CYCLE_MS;

  setTimeout(()=>{ if(phase==="CITY") showZombie(); }, wait);
}

/* ---------- CITY ---------- */
function startCity(){
  phase = "CITY";
  zombieImg.style.display = "none";
  puzzleImg.style.display = "none";
  timerEl.style.display = "none";
  answerRow.style.display = "none";

  if(!audioReady){
    warmUp(groanEl, groanSounds[0]);
    warmUp(scratchEl, "static/scratch.mp3");
    warmUp(gunshot, "static/gunshot.mp3");
    audioReady = true;
  }

  cityImg.src = rand(cityImages);

  const t0 = performance.now();
  function move(t){
    if(phase!=="CITY") return;
    const x = Math.sin((t-t0)/1000*0.6)*30;
    cityImg.style.transform = `translateX(calc(-50% + ${x}px)) scale(1.1)`;
    rafId = requestAnimationFrame(move);
  }
  rafId = requestAnimationFrame(move);

  scheduleZombie();
}

/* ---------- ZOMBIE ---------- */
function showZombie(){
  phase = "ZOMBIE";
  if(rafId) cancelAnimationFrame(rafId);

  zombieImg.src = rand(zombieImages);
  zombieImg.style.display = "block";

  /* ✅ 랜덤 groan 사운드 */
  playSound(groanEl, rand(groanSounds));

  setTimeout(startPuzzle, 2000);
}

/* ---------- PUZZLE ---------- */
function startPuzzle(){
  phase = "PUZZLE";
  if(puzzleIndex >= puzzles.length) puzzleIndex = 0;

  const p = puzzles[puzzleIndex];
  puzzleImg.src = p.img;
  puzzleImg.style.display = "block";

  timerEl.style.display = "block";
  answerRow.style.display = "block";
  answerInput.value = "";
  answerInput.focus();

  let left = 20;
  timerEl.textContent = left;

  countdownId = setInterval(()=>{
    left--;
    timerEl.textContent = left;
    if(left<=0){
      clearInterval(countdownId);
      fail();
    }
  },1000);
}

/* ---------- 결과 ---------- */
function success(){
  phase = "RESULT";
  clearInterval(countdownId);
  puzzleImg.src = "static/success.png";
  playSound(gunshot);
  puzzleIndex++;
  setTimeout(startCity,3000);
}

function fail(){
  phase = "RESULT";
  clearInterval(countdownId);
  puzzleImg.src = "static/fail.png";
  playSound(scratchEl);
  puzzleIndex++;
  setTimeout(startCity,3000);
}

/* ---------- 입력 ---------- */
answerInput.addEventListener("input",()=>{
  answerInput.value = answerInput.value.toUpperCase();
});
answerInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    const p = puzzles[puzzleIndex];
    if(answerInput.value.trim()===p.answer) success();
    else fail();
  }
});

/* ---------- 시작 ---------- */
startCity();
</script>
</body>
</html>

